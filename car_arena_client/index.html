<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>Car Ball Arena (2D) – v2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root{
            --bg:#0b1020;
            --panel:#0a0f24;
            --field1:#141a3a;
            --field2:#101534;
            --line:#334155;
            --text:#e5e7eb;
            --muted:#94a3b8;
            --blue:#60a5fa;
            --red:#f87171;
            --ball:#fbbf24;
            --good:#22c55e;
            --shadow-s:
                inset 0 1px 2px hsla(0, 0%, 100%, 0.1),
                0 1px 2px hsla(0, 0%, 0%, 0.3),
                0 2px 4px hsla(0, 0%, 0%, 0.15);
            --shadow-m:
                inset 0 2px 4px hsla(0, 0%, 100%, 0.1),
                0 2px 4px hsla(0, 0%, 0%, 0.3),
                0 4px 8px hsla(0, 0%, 0%, 0.15);
            --shadow-l:
                inset 0 2px 4px hsla(0, 0%, 100%, 0.1),
                0 4px 6px hsla(0, 0%, 0%, 0.3),
                0 6px 10px hsla(0, 0%, 0%, 0.15);
        }

        /* NEU: Wenn Preferences offen sind, soll das Menü keine Klicks abfangen */
        .prefs-open #ui { pointer-events: none; }
        /* NEU: Zusätzlich z-index des Menüs senken, damit das Modal sicher darüberliegt */
        .prefs-open #ui { z-index: 0; }

        /* NEU: Preferences-Modal deutlich über dem Menü und anderen Overlays */
        #prefsModal { z-index: 20000; }
        #prefsModal .modal-content { z-index: 20001; }

        html,body{
            height:100%; margin:0;
            background:radial-gradient(70% 90% at 50% 10%, #1f2a4a 0%, #040712 60%, #020617 100%);
            color:var(--text);
            font-family:system-ui,-apple-system,Segoe UI,Roboto;
            overflow:hidden;
        }

        canvas{
            display:block; margin:0 auto;
            background:linear-gradient(180deg,var(--field1),var(--field2));
            border-radius:18px;
            box-shadow:0 25px 80px rgba(0,0,0,.55);
        }

        #ui{position:fixed; inset:0; display:grid; place-items:center; padding:18px; z-index: 10015;}
        .card{
            width:min(92vw,540px);
            background:linear-gradient(180deg,#0b122a,#070b1d);
            border:1px solid #1f2937; border-radius:18px; padding:22px;
            box-shadow: var(--shadow-l);
        }
        .card h1{margin:0 0 10px; font-size:28px; letter-spacing:.2px;}
        .card p{margin:0; color:var(--muted); line-height:1.35;}
        .row{display:flex; gap:12px; margin-top:14px;}
        .divider{height:1px; background:rgba(255,255,255,0.08); margin:14px 0;}

        .input{
            height:42px; padding:0 12px; border-radius:12px;
            border:1px solid rgba(255,255,255,0.10);
            background:rgba(0,0,0,0.28); color:var(--text);
            outline:none; box-shadow: var(--shadow-m);
        }
        .input:focus{border-color:rgba(255,255,255,0.22);}

        button{
            flex:1; padding:12px 14px; border-radius:14px;
            border:1px solid rgba(36, 50, 68, 0.3);
            background:#020617; color:var(--text); cursor:pointer; font-size:16px;
            transition:filter .15s ease-in-out;
            box-shadow: var(--shadow-s);
        }
        button.primary{border:none; background:linear-gradient(135deg,#0ea5e9,#22c55e); color:#041016; font-weight:700; box-shadow: var(--shadow-s);}
        button:hover{filter:brightness(1.08);}

        #hud{
            position:fixed; top:12px; left:50%; transform:translateX(-50%);
            display:flex; gap:14px; align-items:center;
            background:rgba(2,6,23,.55);
            border:1px solid rgba(36, 50, 68, 0.2); border-radius:14px;
            padding:8px 12px; backdrop-filter:blur(10px);
            box-shadow: var(--shadow-m);
        }
        #hud .score{font-size:20px; font-weight:700; letter-spacing:.5px;}
        #hud .hint{font-size:12px; color:var(--muted);}

        .kbd{
            display:inline-block; padding:2px 6px;
            border:1px solid #334155; border-bottom-width:2px; border-radius:7px;
            font-size:12px; color:var(--text); background:#0b1020;
            box-shadow: var(--shadow-s);
        }

        /* Countdown Overlay (DOM) */
        #countdownOverlay{
            position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.98);
            width:320px; max-width:88vw; pointer-events:none; display:none;
            align-items:center; justify-content:center; z-index:10010; text-align:center;
        }
        #countdownOverlay.visible{ display:flex; animation: popIn .28s cubic-bezier(.2,.9,.2,1); pointer-events:auto; transform:translate(-50%,-50%) scale(1); }
        @keyframes popIn { from { transform: translate(-50%,-50%) scale(.9); opacity:0 } to { transform: translate(-50%,-50%) scale(1); opacity:1 } }
        #countdownOverlay .backdrop{
            position:absolute; inset:0; border-radius:18px;
            background:linear-gradient(180deg, rgba(2,6,23,0.68), rgba(2,6,23,0.78));
            box-shadow: var(--shadow-l); backdrop-filter:blur(8px);
            border:1px solid rgba(255,255,255,0.04);
        }
        #countdownOverlay .box{position:relative; padding:28px 22px; width:100%; display:flex; flex-direction:column; gap:12px; align-items:center;}
        #countdownRing{
            width:120px; height:120px; border-radius:50%;
            background: conic-gradient(var(--blue) 0deg, rgba(255,255,255,0.06) 0deg);
            display:flex; align-items:center; justify-content:center;
            box-shadow: var(--shadow-m);
        }
        #countdownInner{
            width:84px; height:84px; border-radius:50%;
            background:linear-gradient(180deg,#071022,#03101a);
            display:flex; align-items:center; justify-content:center; color:var(--text);
            font-weight:800; font-size:42px; letter-spacing:1px;
            box-shadow: var(--shadow-s);
        }
        #countdownLabel{ color:var(--muted); font-weight:600; font-size:14px; margin-top:4px; }

        /* Settings Panel (floating, rechts unten) */
        #settingsPanel{
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index:10005;
            display:none; width:320px; max-width:calc(100vw - 40px); max-height:60vh; overflow-y:auto;
            background: linear-gradient(180deg, rgba(22,26,43,0.38), rgba(22,26,43,0.58));
            border:1px solid rgba(255,255,255,0.04); border-radius:18px; padding:16px;
            box-shadow: var(--shadow-l);
            /* angenehme Scrollbar (Firefox + WebKit) */
            scrollbar-width: thin; scrollbar-color: rgba(96,165,250,.45) transparent;
        }
        #settingsPanel.visible{ display:block; }

        /* Header nicht mehr relativ positionieren, damit das X am Panel ausgerichtet wird */
        #settingsPanel .hdr{
            display:flex; align-items:center; gap:10px; margin-bottom:8px; position:static;
            padding-right: 0;
        }
        #settingsPanel .close{
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            margin: 0;
            display: grid;
            place-items: center;

            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 8px;
            color: var(--muted);
            font-size: 14px;
            cursor: pointer;
            box-shadow: var(--shadow-s);
        }
        #settingsPanel .close:hover{ filter:brightness(1.1); }

        .slider-row{ padding:8px 2px; }
        .slider-label{
            display:flex; align-items:center; justify-content:space-between; gap:10px;
            font-size:13px; margin-bottom:6px;
        }
        #settingsPanel .value{ font-weight:700; color:var(--muted); }

        #settingsPanel input[type="range"]{
            -webkit-appearance:none; appearance:none;
            width:100%; height:10px; border-radius:999px;
            background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
            outline:none;
        }
        #settingsPanel input[type="range"]::-webkit-slider-runnable-track{
            height:10px; border-radius:999px;
            background: linear-gradient(90deg, rgba(96,165,250,0.35), rgba(248,113,113,0.25));
        }
        #settingsPanel input[type="range"]::-webkit-slider-thumb{
            -webkit-appearance:none; appearance:none; margin-top:-6px;
            width:22px; height:22px; border-radius:50%;
            background: radial-gradient(circle at 35% 35%, #fff 0%, #e5e7eb 30%, #c7d2fe 60%, #60a5fa 100%);
            border:1px solid rgba(255,255,255,0.35);
            box-shadow: var(--shadow-s);
            cursor:pointer;
        }
        #settingsPanel input[type="range"]::-moz-range-track{
            height:10px; border-radius:999px;
            background: linear-gradient(90deg, rgba(96,165,250,0.35), rgba(248,113,113,0.25));
        }
        #settingsPanel input[type="range"]::-moz-range-thumb{
            width:22px; height:22px; border-radius:50%;
            background: radial-gradient(circle at 35% 35%, #fff 0%, #e5e7eb 30%, #c7d2fe 60%, #60a5fa 100%);
            border:1px solid rgba(255,255,255,0.35);
            box-shadow: var(--shadow-s);
            cursor:pointer;
        }

        /* Preset-Modal */
        #presetModal{
            position:fixed; inset:0; z-index:10000; display:none;
            align-items:center; justify-content:center;
            backdrop-filter: blur(3px); background: rgba(0,0,0,0.5);
            pointer-events:auto;
        }
        #presetModal.visible{ display:flex; }
        #presetModal .modal-content{
            position:relative; width:min(90vw, 500px); max-height:70vh; overflow-y:auto;
            background: linear-gradient(180deg, #0b122a, #070b1d);
            border:1px solid #1f2937; border-radius:18px; padding:24px;
            box-shadow: var(--shadow-l);
        }
        #presetModal .modal-close{
            position:absolute; top:12px; right:12px; width:32px; height:32px; padding:0; font-size:18px; cursor:pointer;
            background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1); color: var(--text); border-radius:6px;
            box-shadow: var(--shadow-s);
        }
        #presetModal h3{ margin:0 0 16px; font-size:18px; font-weight:800; }
        .preset-item{
            display:flex; gap:8px; margin-bottom:10px; padding:10px;
            background: rgba(255,255,255,0.03); border-radius:10px; align-items:center;
            box-shadow: var(--shadow-s);
        }
        .preset-item .name{ flex:1; font-weight:600; color:var(--text); }
        .preset-item button{ flex:0; padding:6px 8px; font-size:12px; width:auto; box-shadow: var(--shadow-s); }

        #pingHud{
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 10020;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(2,6,23,.55);
            border: 1px solid rgba(36, 50, 68, 0.2);
            color: var(--text);
            font-size: 13px;
            box-shadow: var(--shadow-m);
        }

        /* Chat Panel (rechts neben Canvas) */
        #chatPanel{
            position: fixed;
            right: 12px;
            top: 12px;
            width: 280px;
            height: 70vh;
            max-height: 500px;
            z-index: 9500;
            display: none;
            flex-direction: column;
            background: linear-gradient(180deg, rgba(22,26,43,0.38), rgba(22,26,43,0.58));
            border: 1px solid rgba(255,255,255,0.04);
            border-radius: 14px;
            box-shadow: var(--shadow-m);
            pointer-events: auto;
        }
        #chatPanel.visible{ display: flex; }

        #chatMessages{
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            scrollbar-width: thin;
            scrollbar-color: rgba(96,165,250,.35) transparent;
        }
        #chatMessages::-webkit-scrollbar{ width: 8px; }
        #chatMessages::-webkit-scrollbar-track{ background: transparent; }
        #chatMessages::-webkit-scrollbar-thumb{
            background: rgba(96,165,250,.45);
            border-radius: 4px;
        }

        .chat-message{
            font-size: 12px;
            line-height: 1.3;
            padding: 6px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.02);
            color: var(--text);
            word-wrap: break-word;
        }
        .chat-message.system{
            background: rgba(96,165,250,0.1);
            color: var(--blue);
            font-style: italic;
        }
        .chat-message.command{
            background: rgba(248,113,113,0.1);
            color: var(--red);
        }
        .chat-message .nick{
            font-weight: 700;
            color: var(--blue);
            margin-right: 4px;
        }

        #chatInput{
            padding: 8px;
            border-top: 1px solid rgba(255,255,255,0.04);
            display: flex;
            gap: 6px;
        }
        #chatInput input{
            flex: 1;
            height: 32px;
            padding: 0 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.28);
            color: var(--text);
            font-size: 12px;
            outline: none;
        }
        #chatInput input:focus{
            border-color: rgba(255,255,255,0.2);
        }
        #chatInput button{
            padding: 0 10px;
            height: 32px;
            font-size: 12px;
            flex: 0;
            box-shadow: var(--shadow-s);
        }

        #prefsBtn{
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 10020;
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 10px;
            background: rgba(2,6,23,.55);
            border: 1px solid rgba(36, 50, 68, 0.2);
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
            box-shadow: var(--shadow-m);
            display: grid;
            place-items: center;
        }
        #prefsBtn:hover{ filter: brightness(1.1); }

        /* Preferences Modal */
        #prefsModal{
            position:fixed; inset:0; z-index:10000; display:none;
            align-items:center; justify-content:center;
            backdrop-filter: blur(3px); background: rgba(0,0,0,0.5);
            pointer-events:auto;
        }
        #prefsModal.visible{ display:flex; }
        #prefsModal .modal-content{
            position:relative; width:min(90vw, 600px); max-height:80vh; overflow-y:auto;
            background: linear-gradient(180deg, #0b122a, #070b1d);
            border:1px solid #1f2937; border-radius:18px; padding:24px;
            box-shadow: var(--shadow-l);
        }
        #prefsModal .modal-close{
            position:absolute; top:12px; right:12px; width:32px; height:32px; padding:0; font-size:18px; cursor:pointer;
            background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.1); color: var(--text); border-radius:6px;
            box-shadow: var(--shadow-s);
        }
        #prefsModal h3{ margin:0 0 16px; font-size:18px; font-weight:800; }

        .prefs-section{
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .prefs-section:last-child{ border-bottom: none; }
        .prefs-section h4{
            margin: 0 0 12px;
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }

        .color-picker{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }
        .color-option{
            width: 60px;
            height: 60px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.15s ease-in-out;
            box-shadow: var(--shadow-s);
        }
        .color-option:hover{
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        .color-option.selected{
            border-color: #fff;
            box-shadow: 0 0 12px rgba(255,255,255,0.5);
        }

        .team-colors{
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }
        .team-color-block{
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.04);
        }
        .team-color-block h5{
            margin: 0 0 8px;
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
        }

        .key-input-row{
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
        }
        .key-input-row label{
            flex: 0 0 120px;
            font-size: 13px;
            color: var(--text);
        }
        .key-input-row input{
            flex: 1;
            height: 32px;
            padding: 0 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.28);
            color: var(--text);
            font-size: 12px;
            text-align: center;
            outline: none;
        }
        .key-input-row input:focus{
            border-color: rgba(255,255,255,0.2);
        }
        .key-input-row input.recording{
            background: rgba(248,113,113,0.15);
            border-color: var(--red);
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse{
            0%, 100%{ opacity: 1; }
            50%{ opacity: 0.6; }
        }

        .prefs-buttons{
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }
        .prefs-buttons button{
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(36, 50, 68, 0.3);
            background: #020617;
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            box-shadow: var(--shadow-s);
        }
        .prefs-buttons button:hover{
            filter: brightness(1.08);
        }
        .prefs-buttons button.primary{
            background: linear-gradient(135deg,#0ea5e9,#22c55e);
            color: #041016;
            font-weight: 700;
        }
    </style>
</head>
<body>
<button id="prefsBtn" title="Preferences">⚙️</button>

<!-- Preferences Modal -->
<div id="prefsModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-label="Preferences">
        <button class="modal-close" id="prefsModalClose" title="Schließen">✕</button>
        <h3>Preferences</h3>

        <!-- Team Colors Section -->
        <div class="prefs-section">
            <h4>Team Farben</h4>
            <div class="team-colors" id="teamColorsContainer"></div>
        </div>

        <!-- Controls Section -->
        <div class="prefs-section">
            <h4>Steuerung Player 1 (WASD)</h4>
            <div id="controlsPlayer1Container"></div>
        </div>

        <div class="prefs-section">
            <h4>Steuerung Player 2 (Pfeile)</h4>
            <div id="controlsPlayer2Container"></div>
        </div>

        <!-- Buttons -->
        <div class="prefs-buttons">
            <button class="primary" id="prefsResetBtn">Zurücksetzen</button>
            <button id="prefsSaveBtn">Speichern</button>
        </div>
    </div>
</div>

<div id="ui">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="margin:0;">Car Ball Arena</h1>

        </div>

        <!-- Erste Wahl: Lokal oder Online (keine weiteren Buttons sichtbar bis Auswahl) -->
        <div class="row" id="modeSelect" style="margin-top:6px;">
            <button id="btnLocalChoice" class="primary">Lokal</button>
            <button id="btnOnlineChoice">Online</button>
        </div>

        <div class="divider"></div>
        <button id="btnSettings" style="width:100%; padding:8px 10px; font-size:14px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); display: none;">Advanced Settings⚙️</button>


        <!-- Local-Options (versteckt bis "Lokal" gewählt) -->
        <div id="localOptions" style="margin-top:12px; display:none;">
            <div class="divider"></div>
            <div class="row">
                <button id="pvp" class="primary">Spieler vs Spieler</button>
                <button id="pve">Spieler vs Bot</button>
            </div>
            <div class="divider"></div>
        </div>


        <h2 style="margin:14px 0 8px; font-size:16px; font-weight:800;">Online (Server‑Authoritative)</h2>
        <!-- Online-Options (versteckt bis "Online" gewählt) -->
        <div id="onlineOptions" style="gap:10px; flex-wrap:wrap; display:none;">
            <div class="divider"></div>
            <!-- Variantenauswahl: 1v1 oder 2v2 -->
            <div class="row" style="margin-bottom:8px; align-items:center;">
                <label style="font-weight:700; margin-right:8px; line-height:36px;">Variante:</label>
                <select id="onVariant" class="input" style="width:120px;">
                    <option value="2">1 vs 1</option>
                    <option value="4">2 vs 2</option>
                </select>
            </div>

            <!-- Name-Input für Online -->
            <div class="row" style="margin-bottom:8px; align-items:center;">
                <label style="font-weight:700; margin-right:8px; line-height:36px;">Name:</label>
                <input id="onPlayerName" class="input" placeholder="Dein Name" maxlength="20" style="width:160px;" />
            </div>

            <div class="row" style="gap:10px; flex-wrap:wrap;">
                <button id="onHost" class="primary">Online Host</button>
                <input id="onCode" class="input" placeholder="ROOM CODE" maxlength="6" style="width:140px; text-transform:uppercase;" />
                <button id="onJoin">Join</button>
            </div>
            <p id="onStatus" style="margin-top:10px; color:var(--muted); font-size:13px;">Status: Offline</p>
            <div class="divider"></div>
        </div>

        <div class="divider"></div>
        <p style="margin-top:12px; color:var(--muted)">
            <b>Spieler 1</b>: <span class="kbd">W</span> hoch · <span class="kbd">S</span> runter · <span class="kbd">A</span> links · <span class="kbd">D</span> rechts · <span class="kbd">Space</span> Boost
            <br/>
            <b>Spieler 2</b>: <span class="kbd">↑</span> hoch · <span class="kbd">↓</span> runter · <span class="kbd">←</span> links · <span class="kbd">→</span> rechts · <span class="kbd">Shift</span> Boost
        </p>
    </div>
</div>

<div id="hud" hidden>
    <div class="score"><span id="s1">0</span> : <span id="s2">0</span></div>
    <div class="hint">R = Reset · ESC = Menü</div>
    <div class="hint" id="netHud"></div>
    <div class="hint" id="botState" style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
</div>

<!-- Lobby Overlay: wird beim Host/Join sichtbar -->
<div id="lobby" style="position:fixed; inset:auto 20px 20px 20px; z-index:9998; display:none; align-items:flex-start; pointer-events:auto;">
    <div class="card" style="width:min(92vw,720px); display:flex; gap:14px; flex-direction:column;">
        <h2 style="margin:0 0 6px;">Lobby</h2>
        <div style="display:flex; gap:12px;">
            <div style="flex:1; background:rgba(255,255,255,0.02); padding:10px; border-radius:10px;">
                <div style="font-weight:700; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Team Blau</span>
                    <button id="joinBlue" style="padding:6px 8px; font-size:13px;">Beitreten Blau</button>
                </div>
                <div id="slotsBlue" style="display:flex; flex-direction:column; gap:6px;"></div>
            </div>
            <div style="flex:1; background:rgba(255,255,255,0.02); padding:10px; border-radius:10px;">
                <div style="font-weight:700; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Team Rot</span>
                    <button id="joinRed" style="padding:6px 8px; font-size:13px;">Beitreten Rot</button>
                </div>
                <div id="slotsRed" style="display:flex; flex-direction:column; gap:6px;"></div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; gap:12px; margin-top:10px;">
            <div style="color:var(--muted);">Raum: <span id="lobbyCode">—</span> <button id="lobbyCopyBtn" style="padding:4px 8px; font-size:12px; margin-left:6px;">Kopieren</button></div>
            <div style="color:var(--muted);" id="lobbyNotice">Warte auf Spieler…</div>
            <button id="lobbyLeave" style="padding:8px 10px;">Zurück</button>
        </div>
    </div>
</div>

<!-- Countdown Overlay (DOM) -->
<div id="countdownOverlay" aria-hidden="true">
    <div class="backdrop" aria-hidden="true"></div>
    <div class="box">
        <div id="countdownRing" role="status" aria-live="polite">
            <div id="countdownInner">3</div>
        </div>
        <div id="countdownLabel">Spiel startet in</div>
    </div>
</div>

<!-- Floating Settings Panel (rechte Ecke) -->
<div id="settingsPanel" role="dialog" aria-hidden="true" aria-label="Spiel-Einstellungen">
    <div class="hdr">
        <div class="dot" aria-hidden="true"></div>
        <h3>Spiel‑Einstellungen</h3>
        <button class="close" id="settingsClose" title="Schließen">✕</button>
    </div>

    <div class="accent" aria-hidden="true"></div>

    <!-- Preset Quick-Select -->
    <div class="slider-row" style="margin-bottom:8px;">
        <label style="font-weight:700; display:block; margin-bottom:6px;">Preset</label>
        <select id="presetQuickSelect" class="input" style="width:100%;">
            <option value="default">Standard</option>
        </select>
    </div>

    <!-- Sliders (IDs unverändert) -->
    <div class="slider-row">
        <div class="slider-label"><span>Auto‑Beschleunigung</span><span class="value" id="val-carAccel">100%</span></div>
        <input type="range" id="slider-carAccel" min="50" max="150" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Top‑Geschw.</span><span class="value" id="val-carMaxV">100%</span></div>
        <input type="range" id="slider-carMaxV" min="70" max="130" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Boost‑Kraft</span><span class="value" id="val-boostAccMul">100%</span></div>
        <input type="range" id="slider-boostAccMul" min="70" max="150" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Ball‑Trägheit</span><span class="value" id="val-ballDrag">100%</span></div>
        <input type="range" id="slider-ballDrag" min="70" max="130" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Auto‑Bremse</span><span class="value" id="val-carDrag">100%</span></div>
        <input type="range" id="slider-carDrag" min="50" max="150" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Boost‑Aufladung</span><span class="value" id="val-boostRegen">100%</span></div>
        <input type="range" id="slider-boostRegen" min="50" max="150" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Ball‑Elastizität</span><span class="value" id="val-wallBounce">100%</span></div>
        <input type="range" id="slider-wallBounce" min="70" max="140" value="100" step="5">
    </div>

    <div class="slider-row">
        <div class="slider-label"><span>Stoß‑Kraft</span><span class="value" id="val-kickImpulse">100%</span></div>
        <input type="range" id="slider-kickImpulse" min="60" max="150" value="100" step="5">
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="presetsManageBtn" style="flex:1;">Presets verwalten</button>
        <button id="settingsCloseFooter" style="flex:1;">Schließen</button>
    </div>

</div>

<!-- Preset-Modal (neu hinzugefügt) -->
<div id="presetModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-label="Presets verwalten">
        <button class="modal-close" title="Schließen">✕</button>
        <h3>Presets verwalten</h3>
        <div id="presetModalList"></div>
        <div class="row" style="margin-top:10px;">
            <button id="saveNewPresetBtn">Preset speichern</button>
            <button id="presetModalClose">Schließen</button>
        </div>
    </div>
</div>

<div id="pingHud" hidden>Ping: —</div>

<!-- Chat Panel (rechts neben Spielfeld) -->
<div id="chatPanel">
    <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.04); font-weight: 700; font-size: 13px;">Chat</div>
    <div id="chatMessages"></div>
    <div id="chatInput">
        <input id="chatInputField" type="text" placeholder="Nachricht oder /cmd..." maxlength="120">
        <button id="chatSendBtn">Send</button>
    </div>
</div>

<canvas id="game" width="960" height="540"></canvas>

<script>
    // =============================
    //  Car Ball Arena – v2
    //  Fokus: direkte Steuerung, echter Boost, smarterer Bot
    //  Struktur: kleine Engine + Entities => leicht erweiterbar
    // =============================

    // Chat-System
    const CHAT = {
        messages: [],  // { nick, text, type: 'message'|'system'|'command' }
        maxMessages: 50,
    };

    function addChatMessage(nick, text, type='message'){
        CHAT.messages.push({ nick, text, type });
        if (CHAT.messages.length > CHAT.maxMessages){
            CHAT.messages.shift();
        }
        renderChat();
    }

    function renderChat(){
        const container = document.getElementById('chatMessages');
        if (!container) return;
        container.innerHTML = '';
        CHAT.messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = 'chat-message ' + msg.type;
            // Farbe anhand Nick bestimmen: Spielerfarbe, sonst Grau für Viewer/Unbekannt
            let playerColor = getCss('--text');
            let isViewer = false;
            if (typeof msg.nick === 'string' && msg.nick.includes('(Viewer)')) isViewer = true;
            if (!isViewer && (msg.type === 'message' || msg.type === 'command')){
                for (let i=0;i<Object.keys(NET.playerNames).length;i++){
                    if (NET.playerNames[i] === msg.nick){
                        playerColor = (i % 2 === 0) ? getCss('--blue') : getCss('--red');
                        break;
                    }
                }
            }
            if (isViewer || playerColor === getCss('--text')) {
                playerColor = '#9CA3AF'; // Grau für Viewer/Unzugeordnete
            }
            if (msg.type === 'system'){
                div.textContent = msg.text;
            } else if (msg.type === 'command'){
                div.innerHTML = `<span class="nick" style="color:${playerColor};">${msg.nick}:</span> <span style="color:var(--red);">${msg.text}</span>`;
            } else {
                div.innerHTML = `<span class="nick" style="color:${playerColor};">${msg.nick}:</span> ${msg.text}`;
            }
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    }

    function showChat(){
        const panel = document.getElementById('chatPanel');
        if (panel) panel.classList.add('visible');
    }

    function hideChat(){
        const panel = document.getElementById('chatPanel');
        if (panel) panel.classList.remove('visible');
    }

    function sendChatMessage(){
        const input = document.getElementById('chatInputField');
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        const nick = (mode === 'online' && NET.playerIndex !== null)
            ? (NET.playerNames[NET.playerIndex] || 'Player')
            : 'You';
        const isCommand = text.startsWith('/');
        if (mode === 'online'){
            // Online: nicht lokal anzeigen, Server spiegelt zurück
            wsSend({ type: isCommand ? 'chat_command' : 'chat_message', text });
        } else {
            addChatMessage(nick, text, isCommand ? 'command' : 'message');
        }
    }

    // Chat UI Event Handler
    (function initChatUI(){
        const input = document.getElementById('chatInputField');
        const btn = document.getElementById('chatSendBtn');

        if (input){
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        }
        if (btn){
            btn.addEventListener('click', sendChatMessage);
        }
    })();

    // Chat anzeigen/verstecken basierend auf Game-State
    function updateChatVisibility(){
        if (running && mode === 'online') showChat();
        else hideChat();
    }

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const ui = document.getElementById('ui');
    const hud = document.getElementById('hud');
    const s1El = document.getElementById('s1');
    const s2El = document.getElementById('s2');
    const botStateEl = document.getElementById('botState');

    const CFG = {
        pad: 44,
        goalWidth: 140,
        goalDepth: 22,
        centerCircle: 64,

        // Bewegung
        carR: 16,
        carMass: 2.2,
        carAcc: 1750,          // px/s^2
        carMaxSpeed: 395,      // px/s
        carDrag: 6.4,          // linear drag

        // Boost
        boostAccMul: 2.1,
        boostMaxMul: 1.75,
        boostDrain: 50,        // energy per second
        boostRegen: 32,        // energy per second

        // Ball
        ballR: 11,
        ballMass: 1.0,
        ballDrag: 0.95,
        restitution: 0.86,

        // Feel
        wallRestitution: 0.86,
        kickImpulse: 340,      // extra kick on hard hits

        // Bot
        botPrediction: 0.42,
        botSwitchX: 0.52,      // switch defense/attack based on ball x
        botStrafe: 0.18,       // small sideways movement so it doesn't beeline
        botBoostDist: 160,
    };
    // Standard-CFG sichern, um lokale Spiele nicht durch Online-Overrides zu beeinflussen
    const CFG_DEFAULT = JSON.parse(JSON.stringify(CFG));

    // ---------- Online (Server-Authoritative via WebSocket) — jetzt über Relay ----------
    // Trage hier deine Relay-URL ein (wss://...):
    const WS_URL = "wss://cararena-relay.up.railway.app/" || "wss://localhost:8081/";

    const NET = {
        ws: null,
        connected: false,
        roomCode: "",
        playerIndex: null,
        playerId: null,
        lastState: null,
        lastStateAt: 0,
        sendTimer: null,
        seq: 0,
        playerNames: {},
        pingTimer: null,
        lastPingSentAt: 0,
        pingMs: null,
        countdownStartAt: null,
        currentTournament: null,
    };

    // client-seitige Erwartung (für Anzeige bevor Server bestätigt)
    let expectedPlayers = 2;

    function netSetStatus(text){
        const el = document.getElementById('onStatus');
        if (el) el.textContent = 'Status: ' + text;
        const hud = document.getElementById('netHud');
        if (hud){
            hud.textContent = (mode==='online' && NET.connected)
                ? ('Online • Room ' + NET.roomCode + ' • P' + (NET.playerIndex??'?'))
                : '';
        }
    }

    function wsSend(obj){
        if (NET.ws && NET.ws.readyState === 1){
            NET.ws.send(JSON.stringify(obj));
        }
    }

    function netDisconnect(){
        try{ if (NET.sendTimer) clearInterval(NET.sendTimer); }catch{}
        NET.sendTimer = null;
        NET.connected = false;
        NET.lastState = null;
        NET.roomCode = "";
        NET.playerIndex = null;
        try{ if (NET.pingTimer) clearInterval(NET.pingTimer); }catch{}
        NET.pingTimer = null;
        NET.pingMs = null;
        updatePingHud(NET.pingMs);
        if (NET.ws){
            try{ NET.ws.close(); }catch{}
        }
        NET.ws = null;
        netSetStatus('Offline');
    }

    function netConnect(){
        return new Promise((resolve, reject) => {
            if (!WS_URL || WS_URL.includes('YOUR-RELAY-SERVICE')){
                netSetStatus('WS_URL fehlt (Relay-URL eintragen)');
                reject(new Error('WS_URL not set'));
                return;
            }

            netSetStatus('Relay: Verbinden…');
            const ws = new WebSocket(WS_URL);
            NET.ws = ws;

            ws.onopen = () => {
                NET.connected = true;
                NET.playerId = Math.random().toString(36).slice(2, 10);
                // Registriere dich beim Relay als Player
                wsSend({ type: 'player_connect', playerId: NET.playerId });
                netSetStatus('Relay: Verbunden');
            };
            ws.onclose = () => {
                NET.connected = false;
                netSetStatus('Relay: Getrennt');
            };
            ws.onerror = (e) => {
                NET.connected = false;
                netSetStatus('Relay: Fehler');
                reject(e);
            };

            ws.onmessage = (ev) => {
                let msg;
                try{ msg = JSON.parse(ev.data); }catch{ return; }

                if (msg.type === 'relay_welcome'){
                    console.log('[Relay] Welcome:', msg);
                    return;
                }

                // NEU: Relay signalisiert, dass eine Instanz aufgeweckt wird
                if (msg.type === 'assign_pending'){
                    netSetStatus('Relay: Instanz wird gestartet…');
                    return;
                }

                // NEU/weiterhin: Relay liefert direkt Ziel-Instanz via room_created/join_ok inkl. gamePort
                if (msg.type === 'room_created' || msg.type === 'join_ok'){
                    const gamePort = msg.gamePort || 8080;
                    const gameWsUrl = `ws://${window.location.hostname}:${gamePort}/`;
                    ws.close();
                    NET.connected = false;

                    netSetStatus('Game-Server: Verbinden…');
                    const gameWs = new WebSocket(gameWsUrl);
                    NET.ws = gameWs;
                    NET.connected = true;

                    gameWs.onopen = () => {
                        wsSend({
                            type: msg.type === 'room_created' ? 'create_room' : 'join_room',
                            code: msg.code,
                            playerId: NET.playerId,
                            playerName: msg.playerName,
                            maxPlayers: msg.maxPlayers
                        });
                        netSetStatus('Game-Server: Verbunden');
                        resolve();
                    };
                    gameWs.onclose = () => { NET.connected = false; netSetStatus('Game-Server: Getrennt'); };
                    gameWs.onerror = () => { NET.connected = false; netSetStatus('Game-Server: Fehler'); };
                    gameWs.onmessage = (ev2) => {
                        let gameMsg; try{ gameMsg = JSON.parse(ev2.data); }catch{ return; }
                        handleGameMessage(gameMsg);
                    };
                    return;
                }

                // ...existing code (andere Relay-Events)...
            };
        });
    }

    function handleGameMessage(msg){
        if (msg.type === 'pong'){
            const sent = (typeof msg.t === 'number') ? msg.t : NET.lastPingSentAt;
            const rtt = performance.now() - sent;
            NET.pingMs = rtt;
            updatePingHud(rtt);
            return;
        }

        if (msg.type === 'room_created'){
            NET.roomMaxPlayers = msg.maxPlayers || 2;
            expectedPlayers = NET.roomMaxPlayers;
            NET.roomCode = msg.code;
            NET.playerIndex = msg.playerIndex;
            NET.lastState = null;
            NET.seq = 0;
            mode = 'online';
            enterLobby();
            netSetStatus('Host • Code ' + NET.roomCode);
            if (msg.cfgPartial) applyOnlineCfg(msg.cfgPartial);
        } else if (msg.type === 'join_ok'){
            NET.roomMaxPlayers = msg.maxPlayers || 2;
            expectedPlayers = NET.roomMaxPlayers;
            NET.roomCode = msg.code;
            NET.playerIndex = msg.playerIndex;
            NET.lastState = null;
            NET.seq = 0;
            mode = 'online';
            enterLobby();
            netSetStatus('Joined • Code ' + NET.roomCode);
            if (msg.cfgPartial) applyOnlineCfg(msg.cfgPartial);
        } else if (msg.type === 'join_failed'){
            netSetStatus('Join failed: ' + (msg.reason || 'unknown'));
            leaveLobby();
        } else if (msg.type === 'state'){
            NET.lastState = msg;
            NET.lastStateAt = performance.now();
            if (msg.playerNames) NET.playerNames = msg.playerNames;
            const lobbyEl = document.getElementById('lobby');
            if (lobbyEl && lobbyEl.style.display === 'block') renderLobby();
            if (msg.started) {
                startOnline();
                if (lobbyEl) lobbyEl.style.display = 'none';
            }
        } else if (msg.type === 'start'){
            if (msg.cfgPartial) applyOnlineCfg(msg.cfgPartial);
            startOnline();
            const lobbyEl = document.getElementById('lobby');
            if (lobbyEl) lobbyEl.style.display = 'none';
        } else if (msg.type === 'player_joined' || msg.type === 'player_left'){
            if (msg.playerNames) { NET.playerNames = msg.playerNames; }
            const lobbyEl = document.getElementById('lobby');
            if (lobbyEl && lobbyEl.style.display === 'block') renderLobby();
        } else if (msg.type === 'countdown_start'){
            NET.countdownStartAt = performance.now();
            const lobbyEl = document.getElementById('lobby');
            if (lobbyEl && lobbyEl.style.display === 'block') renderLobby();
            showCountdown(3, 3, 'Spiel startet in');
        } else if (msg.type === 'switch_failed'){
            netSetStatus('Teamwechsel fehlgeschlagen: ' + (msg.reason || 'busy'));
        } else if (msg.type === 'switch_ok'){
            if (typeof msg.newIndex === 'number') NET.playerIndex = msg.newIndex;
        } else if (msg.type === 'room_closed'){
            netSetStatus('Room closed');
            leaveLobby();
        } else if (msg.type === 'chat_message'){
            const nick = msg.nick || 'Player';
            const text = msg.text || '';
            addChatMessage(nick, text, 'message');
        } else if (msg.type === 'chat_command'){
            const nick = msg.nick || 'Player';
            const text = msg.text || '';
            addChatMessage(nick, text, 'command');
        } else if (msg.type === 'chat_system'){
            const text = msg.text || '';
            addChatMessage('System', text, 'system');
        } else if (msg.type === 'tournament_config'){
            TOURN.enabled = true; TOURN.mode = msg.mode; TOURN.config = msg.config; TOURN.phase = msg.phase || 'Gruppenphase';
            renderTournamentOverlay();
        } else if (msg.type === 'tournament_state'){
            TOURN.enabled = true; TOURN.phase = msg.phase || TOURN.phase; TOURN.groups = msg.groups || []; TOURN.bracket = msg.bracket || [];
            renderTournamentOverlay();
        } else if (msg.type === 'tournament_pause'){
            TOURN.pauseUntil = performance.now() + 15000;
            showCountdown(15, 15, 'Turnier-Pause');
        } else if (msg.type === 'tournament_resume'){
            TOURN.pauseUntil = 0; hideCountdown();
        }
    }

    // ...existing code...

